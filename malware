VPS Malware Incident Report & Full Cleanup Guide (Complete Notes + Commands)
For Future Recovery – Reusable Prompt + Full Scenario Documentation

──────────────────────────────────────────────────────────────
──────────────────────────────────────────────────────────────

REUSABLE PROMPT (Use this when issue happens again)
My VPS is showing high CPU steal or abnormal CPU usage.  
Check for malware processes, hidden miners, fake services, rogue cronjobs, persistent autostart scripts, malicious binaries under /dev, /tmp, /usr/local/bin, or inside project folders.  
Scan systemd services for miners like xmrig, c3pool_miner, fghgf, 7rl47, networkerd, eventse, lived, alive.  

Then give me commands to:  
- kill malicious processes  
- remove binaries  
- disable & delete systemd services  
- remove cron entries  
- delete persistence files  
- clean infected project folders  
- verify with ps, systemctl, cron, find, grep  
- confirm no xmrig or miner remains  
- check CPU steal after cleanup.  

Follow the same steps as in my previous incident resolution.


──────────────────────────────────────────────────────────────
──────────────────────────────────────────────────────────────

FULL INCIDENT DOCUMENTATION (800+ lines style, compressed but complete)

Below is the full scenario: detection → investigation → cleaning → verification.

You can store this as your master reference.

──────────────────────────────────────────────────────────────

1. INITIAL SYMPTOMS

VPS extremely slow

top shows 90–99% CPU stolen time (st)

Multiple unknown binaries running:

fghgf

xmrig

7rl47ms2hmpa3pn

Load average 10+ on a 2-core VM

Memory almost full

Hostinger applied automatic CPU throttling

Example output:

%Cpu(s): 60.6 us, 29.9 sy, 0.2 ni, 0.0 id, 0.0 wa, 0.0 hi, 2.3 si, 7.1 st


──────────────────────────────────────────────────────────────

2. FINDING MALWARE USING TOP + PS

Commands used:

top
htop
ps aux | grep -E "xmrig|fghgf|miner|7rl47"


Found:

/var/www/acmeglobal-next.js/build-new/xmrig
/var/www/starglass/xmrig-6.24.0/xmrig
/dev/fghgf -c /dev/ijnegrrinje.json
/bin/bash -c "while true ... kill xmrig"


──────────────────────────────────────────────────────────────

3. FINDING SYSTEMD-BASED PERSISTENCE

The attacker created fake services:

/etc/systemd/system/system-update-service.service
/etc/systemd/system/systems-update-service.service
/etc/systemd/system/system-cleanup-service.service
/etc/systemd/system/multi-user.target.wants/*


Detection command:

grep -R "xmrig\|fghgf\|7rl47\|miner" /etc/systemd/system


Found ExecStart values pointing to malicious miners.

──────────────────────────────────────────────────────────────

4. FINDING CRON-BASED PERSISTENCE

Checked cron:

grep -R "xmrig\|fghgf\|7rl47" /etc/cron*
grep -R "xmrig\|fghgf\|7rl47" /var/spool/cron


No cron persistence found (good).

──────────────────────────────────────────────────────────────

5. FINDING MALICIOUS FILES

Commands:

find / -type f -name "xmrig*" 2>/dev/null
find / -type f -size +50k -executable 2>/dev/null | grep -E "xmrig|fghgf|7rl47"


Found:

/var/www/acmeglobal-next.js/build-new/xmrig
/var/www/starglass/xmrig-6.24.0/xmrig
/dev/fghgf
/dev/ijnegrrinje.json
/usr/local/bin/fghgf
/tmp/fghgf*


──────────────────────────────────────────────────────────────

6. KILLING MALWARE PROCESSES

Used:

pkill -f xmrig
pkill -f fghgf
pkill -f 7rl47ms2hmpa3pn
pkill -f "while true"


Verified:

ps aux | grep -E "xmrig|fghgf|miner"


──────────────────────────────────────────────────────────────

7. REMOVING MALICIOUS FILES

Commands executed:

rm -f /dev/fghgf
rm -f /dev/ijnegrrinje.json
rm -f /tmp/fghgf*
rm -f /root/fghgf*
rm -f /usr/local/bin/fghgf
rm -rf /var/www/acmeglobal-next.js
rm -rf /var/www/starglass


──────────────────────────────────────────────────────────────

8. DISABLING MALICIOUS SERVICES

Commands:

systemctl stop system-update-service.service
systemctl stop systems-update-service.service
systemctl stop system-cleanup-service.service

systemctl disable system-update-service.service
systemctl disable systems-update-service.service
systemctl disable system-cleanup-service.service


Removing files:

rm -f /etc/systemd/system/system-update-service.service
rm -f /etc/systemd/system/systems-update-service.service
rm -f /etc/systemd/system/system-cleanup-service.service
rm -f /etc/systemd/system/multi-user.target.wants/system-update-service.service
rm -f /etc/systemd/system/multi-user.target.wants/systems-update-service.service
rm -f /etc/systemd/system/multi-user.target.wants/system-cleanup-service.service


Reload:

systemctl daemon-reload
systemctl reset-failed


──────────────────────────────────────────────────────────────

9. VERIFYING SYSTEM IS CLEAN

Commands executed:

ps aux | grep -E "xmrig|fghgf|miner"
systemctl list-units --type=service | grep -E "update|cleanup|xmrig"
find / -type f -executable -size +50k | grep -E "xmrig|fghgf|7rl47"
grep -R "xmrig" /etc


All returned no results.

──────────────────────────────────────────────────────────────

10. CHECKING CPU STEAL AFTER CLEANUP
vmstat 5 5


Before cleanup:

st = 90%


After cleanup:

st = 0–2% (normal)


──────────────────────────────────────────────────────────────

11. WHY INFECTION HAPPENED

Most likely:

✔ A Node project folder contained a malicious binary (XMrig)
✔ A PM2 or Node script downloaded and executed a miner (log showed c3pool.org)
✔ Attacker installed systemd services with auto-restart loops
✔ Malware copied itself into /dev, /tmp, and /usr/local/bin

──────────────────────────────────────────────────────────────

12. SECURITY HARDENING (PERMANENT FIX)

Apply these steps:

A. Remove all unused projects

Delete any old Next.js or Node projects.

B. Reinstall PM2 fresh
pm2 kill
npm uninstall pm2 -g
npm install pm2 -g
pm2 startup

C. Enable fail2ban

Already running on your system.

D. Set UFW firewall
ufw default deny incoming
ufw allow ssh
ufw allow http
ufw allow https
ufw enable

E. Change SSH keys

Regenerate:

rm -f ~/.ssh/authorized_keys


Then re-add your clean key.

──────────────────────────────────────────────────────────────

13. FINAL STATUS

✔ All miner binaries removed
✔ All processes killed
✔ All persistence removed
✔ All malicious systemd services deleted
✔ CPU steal normal again
✔ VPS performance restored ✔
